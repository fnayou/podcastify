version: "3"

dotenv: [".env", ".env.local"]

vars:
  COMPOSE: docker compose
  SERVICE_NAME: podcastify
  APP_SCRIPT: /app/app.py
  PUBLIC_DIR: ./public
  PODCASTS_DIR: ./podcasts
  LOG_LINES: 200

includes:
  dev:
    taskfile: ./Taskfile.dev.yml
    optional: true

tasks:
  default:
    desc: "Show all available tasks with descriptions"
    silent: true
    cmds:
      - |
        echo "üéôÔ∏è  Podcast RSS Generator - Available Tasks"
        echo "=========================================="
        task --list
        echo
        echo "üí° Use 'task <command>' to run tasks"

  info:
    desc: "Show system and project information"
    silent: true
    cmds:
      - |
        echo "üìä System Information"
        echo "===================="
        echo 'Docker Compose: {{ .COMPOSE }}'
        echo 'Service Name: {{ .SERVICE_NAME }}'
        echo 'Public Directory: {{ .PUBLIC_DIR }}'
        echo 'Podcasts Directory: {{ .PODCASTS_DIR }}'
        echo
        echo "üìÅ Directory Status:"
        if [ -d '{{.PUBLIC_DIR}}' ]; then echo "Public dir exists: ‚úÖ"; else echo "Public dir exists: ‚ùå"; fi
        if [ -d '{{.PODCASTS_DIR}}' ]; then echo "Podcasts dir exists: ‚úÖ"; else echo "Podcasts dir exists: ‚ùå"; fi
        echo
        echo "üê≥ Docker Status:"
        {{.COMPOSE}} ps {{.SERVICE_NAME}} 2>/dev/null || echo "‚ùå Service not running"

  # ---------------------------------------------------------------------------
  # Docker lifecycle
  # ---------------------------------------------------------------------------

  up:
    desc: "üöÄ Build and start the podcast generator service"
    silent: true
    cmds:
      - 'echo "üèóÔ∏è  Building and starting {{.SERVICE_NAME}} service..."'
      - "{{.COMPOSE}} up -d --build"
      - 'echo "‚úÖ Service started successfully!"'
      - task: status

  down:
    desc: "üõë Stop and remove containers"
    silent: true
    cmds:
      - 'echo "üõë Stopping {{.SERVICE_NAME}} service..."'
      - "{{.COMPOSE}} down"
      - 'echo "‚úÖ Service stopped successfully!"'

  restart:
    desc: "üîÑ Restart the service with rebuild"
    silent: true
    cmds:
      - 'echo "üîÑ Restarting {{.SERVICE_NAME}} service..."'
      - task: down
      - task: up

  status:
    desc: "üìä Show service status and health"
    silent: true
    cmds:
      - |
        echo "üìä Service Status:"
        {{.COMPOSE}} ps {{.SERVICE_NAME}}
        echo
        echo "üíæ Recent logs (last 10 lines):"
        {{.COMPOSE}} logs --tail=10 {{.SERVICE_NAME}} 2>/dev/null || echo "No logs available"

  # ---------------------------------------------------------------------------
  # Logs & debugging
  # ---------------------------------------------------------------------------

  logs:
    desc: "üìã Follow service logs in real-time"
    silent: true
    interactive: true
    cmds:
      - 'echo "üìã Following logs for {{.SERVICE_NAME}} (Ctrl+C to stop)..."'
      - "{{.COMPOSE}} logs -f --tail={{.LOG_LINES}} {{.SERVICE_NAME}} {{.CLI_ARGS}}"

  logs:recent:
    desc: "üìã Show recent logs without following"
    silent: true
    cmds:
      - "{{.COMPOSE}} logs --tail={{.LOG_LINES}} {{.SERVICE_NAME}} {{.CLI_ARGS}}"

  logs:errors:
    desc: "üö® Show only error/warn/fail logs (full lines)"
    silent: true
    cmds:
      - |
        {{.COMPOSE}} logs {{.SERVICE_NAME}} | grep -Ei "error|warn|fail|traceback" || echo "No errors found in logs"

  shell:
    desc: "üêö Open interactive shell in running container"
    silent: true
    interactive: true
    preconditions:
      - sh: 'test -n "$({{.COMPOSE}} ps -q {{.SERVICE_NAME}})"'
        msg: "Service {{.SERVICE_NAME}} is not running. Use 'task up' first."
    cmds:
      - 'echo "üêö Opening shell in {{.SERVICE_NAME}} container..."'
      - "{{.COMPOSE}} exec {{.SERVICE_NAME}} sh"

  shell:root:
    desc: "üîß Open root shell in running container (for debugging)"
    silent: true
    interactive: true
    preconditions:
      - sh: 'test -n "$({{.COMPOSE}} ps -q {{.SERVICE_NAME}})"'
        msg: "Service {{.SERVICE_NAME}} is not running. Use 'task up' first."
    cmds:
      - 'echo "üîß Opening root shell in {{.SERVICE_NAME}} container..."'
      - "{{.COMPOSE}} exec --user root {{.SERVICE_NAME}} sh"

  inspect:
    desc: "üîç Show container configuration and environment"
    silent: true
    preconditions:
      - sh: 'test -n "$({{.COMPOSE}} ps -q {{.SERVICE_NAME}})"'
        msg: "Service {{.SERVICE_NAME}} is not running. Use 'task up' first."
    cmds:
      - |
        echo "üîç Container Environment:"
        {{.COMPOSE}} exec {{.SERVICE_NAME}} env | sort
        echo
        echo "üîç Container Processes:"
        {{.COMPOSE}} exec {{.SERVICE_NAME}} ps aux

  # ---------------------------------------------------------------------------
  # Build & images
  # ---------------------------------------------------------------------------

  build:
    desc: "üèóÔ∏è  Rebuild image without cache"
    cmds:
      - 'echo "üèóÔ∏è  Rebuilding {{.SERVICE_NAME}} image (no cache)..."'
      - "{{.COMPOSE}} build --no-cache {{.SERVICE_NAME}}"
      - 'echo "‚úÖ Image rebuilt successfully!"'

  build:quick:
    desc: "‚ö° Quick rebuild with cache"
    cmds:
      - 'echo "‚ö° Quick rebuild of {{.SERVICE_NAME}} image..."'
      - "{{.COMPOSE}} build {{.SERVICE_NAME}}"
      - 'echo "‚úÖ Quick build completed!"'

  pull:
    desc: "‚¨áÔ∏è  Pull latest base images"
    silent: true
    cmds:
      - 'echo "‚¨áÔ∏è  Pulling latest base images..."'
      - "{{.COMPOSE}} pull"
      - 'echo "‚úÖ Base images updated!"'

  # ---------------------------------------------------------------------------
  # Feeds
  # ---------------------------------------------------------------------------

  generate:
    desc: "üéôÔ∏è  Generate RSS feeds now (works with running or stopped service)"
    silent: true
    cmds:
      - |
        echo "üéôÔ∏è  Generating RSS feeds..."
        if [ -n "$({{.COMPOSE}} ps -q {{.SERVICE_NAME}})" ]; then
          echo "üì° Using running container..."
          {{.COMPOSE}} exec {{.SERVICE_NAME}} python {{.APP_SCRIPT}} generate
        else
          echo "üöÄ Starting temporary container..."
          {{.COMPOSE}} run --rm --entrypoint '' {{.SERVICE_NAME}} python {{.APP_SCRIPT}} generate
        fi
        echo "‚úÖ RSS generation completed!"

  generate:watch:
    desc: "üëÄ Watch configs and auto-regenerate feeds (Linux; requires inotifywait)"
    silent: true
    interactive: true
    deps: [setup:dirs]
    cmds:
      - |
        if ! command -v inotifywait >/dev/null 2>&1; then
          echo "‚ùå inotifywait not found. Install inotify-tools or use another watcher."
          exit 1
        fi
        echo "üëÄ Watching {{.PODCASTS_DIR}} for changes (Ctrl+C to stop)..."
        while inotifywait -e modify,create,delete,move -r "{{.PODCASTS_DIR}}"; do
          echo "üîÑ Change detected, regenerating feeds..."
          task generate:silent
        done

  generate:watch-public:
    desc: "üëÄ Watch public media for changes (Linux; requires inotifywait)"
    silent: true
    interactive: true
    deps: [setup:dirs]
    cmds:
      - |
        if ! command -v inotifywait >/dev/null 2>&1; then
          echo "‚ùå inotifywait not found. Install inotify-tools or use another watcher."
          exit 1
        fi
        echo "üëÄ Watching {{.PUBLIC_DIR}} for changes (Ctrl+C to stop)..."
        while inotifywait -e modify,create,delete,move -r "{{.PUBLIC_DIR}}"; do
          echo "üîÑ Media change detected, regenerating feeds..."
          task generate:silent
        done

  generate:silent:
    desc: "ü§´ Generate feeds silently (internal use)"
    silent: true
    internal: true
    cmds:
      - |
        if [ -n "$({{.COMPOSE}} ps -q {{.SERVICE_NAME}})" ]; then
          {{.COMPOSE}} exec {{.SERVICE_NAME}} python {{.APP_SCRIPT}} generate
        else
          {{.COMPOSE}} run --rm --entrypoint '' {{.SERVICE_NAME}} python {{.APP_SCRIPT}} generate
        fi

  # ---------------------------------------------------------------------------
  # Cleanup
  # ---------------------------------------------------------------------------

  clean:feeds:
    desc: "üßπ Remove generated RSS feeds (keeps media files)"
    silent: true
    cmds:
      - 'echo "üßπ Cleaning generated RSS feeds..."'
      - rm -f {{.PUBLIC_DIR}}/*.xml
      - 'echo "‚úÖ RSS feeds cleaned!"'

  clean:all:
    desc: "üßπ Clean everything (containers, images, feeds)"
    silent: true
    prompt: "This will remove all containers, images, and RSS feeds. Continue?"
    cmds:
      - task: clean:feeds
      - 'echo "üßπ Removing containers and images..."'
      - "{{.COMPOSE}} down --rmi all --volumes"
      - 'echo "‚úÖ Full cleanup completed!"'

  clean:docker:
    desc: "üê≥ Clean Docker resources (containers, networks, volumes)"
    silent: true
    prompt: "This will remove containers, networks, and volumes. Continue?"
    cmds:
      - 'echo "üê≥ Cleaning Docker resources..."'
      - "{{.COMPOSE}} down --volumes"
      - docker system prune -f
      - 'echo "‚úÖ Docker cleanup completed!"'

  # ---------------------------------------------------------------------------
  # Utilities
  # ---------------------------------------------------------------------------

  env:
    desc: "üåç Show current environment variables"
    silent: true
    cmds:
      - |
        echo "üåç Current Environment:"
        echo 'COMPOSE={{.COMPOSE}}'
        echo 'SERVICE_NAME={{.SERVICE_NAME}}'
        echo 'PUBLIC_DIR={{.PUBLIC_DIR}}'
        echo 'PODCASTS_DIR={{.PODCASTS_DIR}}'
        echo
        echo "üê≥ Docker Compose Environment:"
        {{.COMPOSE}} config --quiet 2>/dev/null && echo '‚úÖ Compose file valid' || echo '‚ùå Compose file invalid'

  health:
    desc: "üè• Run health check on service"
    silent: true
    cmds:
      - |
        echo "üè• Health Check Results:"
        task info
        echo

  version:
    desc: "üìä Show version information"
    silent: true
    cmds:
      - |
        echo "üìä Version Information:"
        task --version
        docker --version
        {{.COMPOSE}} version || true
        echo
        echo "üìÅ Project files:"
        test -f Taskfile.yml && echo "Taskfile.yml: ‚úÖ" || echo "Taskfile.yml: ‚ùå"
        test -f docker-compose.yml && echo "docker-compose.yml: ‚úÖ" || echo "docker-compose.yml: ‚ùå"

  doctor:
    desc: "üîé Check required tools and directories"
    silent: true
    cmds:
      - |
        ok=1
        for bin in docker task grep; do
          command -v "$bin" >/dev/null 2>&1 || { echo "‚ùå Missing: $bin"; ok=0; }
        done
        # check compose (subcommand)
        {{.COMPOSE}} version >/dev/null 2>&1 || { echo "‚ùå Problem with docker compose"; ok=0; }
        [ -d "{{.PUBLIC_DIR}}" ]   || { echo "‚ùå Missing dir: {{.PUBLIC_DIR}}"; ok=0; }
        [ -d "{{.PODCASTS_DIR}}" ] || { echo "‚ùå Missing dir: {{.PODCASTS_DIR}}"; ok=0; }
        [ $ok -eq 1 ] && echo "‚úÖ All good" || exit 1

  compose:config:
    desc: "üß© Show resolved docker-compose config"
    silent: true
    cmds:
      - "{{.COMPOSE}} config"

  compose:ps:
    desc: "üìã List compose services/containers"
    silent: true
    cmds:
      - "{{.COMPOSE}} ps"

  new:
    desc: "üÜï Create a new flat config: task new NAME=myshow"
    silent: true
    vars:
      NAME: '{{.NAME | default "example"}}'
    cmds:
      - |
        target="{{.PODCASTS_DIR}}/{{.NAME}}-podcast.yaml"
        if [ -f "$target" ]; then
          echo "‚ö†Ô∏è  Already exists: $target"; exit 1
        fi
        mkdir -p "{{.PODCASTS_DIR}}"
        printf '%s\n' \
        'name: {{.NAME}}' \
        'title: "{{.NAME | title }} Podcast"' \
        'description: "Personal feed for {{.NAME}}"' \
        'author-name: "Your Name"' \
        'author-email: "you@example.com"' \
        'language: "en"' \
        'explicit: false' \
        'image: "cover.jpg"' \
        'categories:' \
        '  - "Technology"' \
        '' \
        'episodes:' \
        '  - file: "episode-001.mp3"' \
        '    title: "Episode 001"' \
        '    description: "First episode"' \
        '    pub_date: "2024-01-01T00:00:00Z"' \
        > "$target"
        echo "üìù Created: $target"
        echo "üì¶ Put media under: {{.PUBLIC_DIR}}/{{.NAME}}/"

  fix:perms:
    desc: "üîê Chown podcasts/public to UID:GID (Linux host). Usage: task fix:perms UID=$(id -u) GID=$(id -g)"
    silent: true
    vars:
      UID: '{{.UID | default "1000"}}'
      GID: '{{.GID | default "1000"}}'
    cmds:
      - sudo chown -R {{.UID}}:{{.GID}} {{.PODCASTS_DIR}} {{.PUBLIC_DIR}} || true

  # ---------------------------------------------------------------------------
  # Short aliases
  # ---------------------------------------------------------------------------

  docker:up:
    desc: "Alias for 'up'"
    silent: true
    cmds: ["task up"]
  docker:down:
    desc: "Alias for 'down'"
    silent: true
    cmds: ["task down"]
  docker:restart:
    desc: "Alias for 'restart'"
    silent: true
    cmds: ["task restart"]
  docker:logs:
    desc: "Alias for 'logs'"
    silent: true
    cmds: ["task logs"]
  docker:shell:
    desc: "Alias for 'shell'"
    silent: true
    cmds: ["task shell"]
  docker:build:
    desc: "Alias for 'build'"
    silent: true
    cmds: ["task build"]

  gen:
    desc: "Quick alias for 'generate'"
    silent: true
    cmds: ["task generate"]
